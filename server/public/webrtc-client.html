<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC P2P Demo</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
        .container { max-width: 1200px; margin: 0 auto; }
        .video-container { display: flex; gap: 20px; margin: 20px 0; }
        video { width: 400px; height: 300px; background: #000; border: 2px solid #333; }
        .controls { margin: 20px 0; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background: #0056b3; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; background: #e9ecef; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        .info { background: #d1ecf1; color: #0c5460; }
        #log { height: 200px; overflow-y: auto; background: white; padding: 10px; border: 1px solid #ddd; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebRTC P2P Demo</h1>
        <div id="status" class="status">準備完了</div>
        
        <div class="controls">
            <button id="startLocalVideo">ローカル映像開始</button>
            <button id="createRoom" disabled>ルーム作成</button>
        </div>
        
        <div class="video-container">
            <div>
                <h3>ローカル映像</h3>
                <video id="localVideo" autoplay muted playsinline></video>
            </div>
            <div>
                <h3>リモート映像</h3>
                <video id="remoteVideo" autoplay playsinline></video>
            </div>
        </div>
        
        <div id="log"></div>
    </div>

    <script>
        const ROOM_ID = 'demo-room';
        
        let localStream = null;
        
        // UI要素
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        
        // ボタン
        const startLocalVideoBtn = document.getElementById('startLocalVideo');
        const createRoomBtn = document.getElementById('createRoom');
        
        function log(message) {
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${time}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, type = 'info') {
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        // ローカル映像取得
        startLocalVideoBtn.addEventListener('click', async () => {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 },
                    audio: true
                });
                localVideo.srcObject = localStream;
                log('ローカル映像を取得しました');
                updateStatus('ローカル映像取得完了', 'success');
                startLocalVideoBtn.disabled = true;
                createRoomBtn.disabled = false;
            } catch (error) {
                log('ローカル映像取得に失敗: ' + error.message);
                updateStatus('映像取得エラー', 'error');
            }
        });
        
        // ルーム作成
        createRoomBtn.addEventListener('click', async () => {
            try {
                const response = await fetch(`/rooms/${ROOM_ID}`, { method: 'POST' });
                const data = await response.json();
                log(`ルーム作成完了: ${data.roomId}`);
                updateStatus('ルーム作成完了', 'success');
                createRoomBtn.disabled = true;
            } catch (error) {
                log('ルーム作成に失敗: ' + error.message);
                updateStatus('ルーム作成エラー', 'error');
            }
        });
    </script>
</body>
</html>
                const roomData = await roomResponse.json();
                log(`ルーム参加: ${roomData.roomId}`);
                
                // デバイス初期化
                device = new mediasoupClient.Device();
                await device.load({ routerRtpCapabilities: roomData.rtpCapabilities });
                log('MediaSoup Device初期化完了');
                
                updateStatus('ルーム参加完了', 'success');
                joinRoomBtn.disabled = true;
                startSendingBtn.disabled = false;
                startReceivingBtn.disabled = false;
                
                // 既存プロデューサーをチェック
                await checkExistingProducers();
                
            } catch (error) {
                log('ルーム参加に失敗: ' + error.message);
                updateStatus('ルーム参加エラー', 'error');
            }
        });
        
        // 映像送信開始
        startSendingBtn.addEventListener('click', async () => {
            try {
                if (!localStream) {
                    throw new Error('ローカル映像が取得されていません');
                }
                
                // Producer Transport作成
                const transportResponse = await fetch(`${API_BASE}/transports`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'producer',
                        forceTcp: false,
                        producing: true,
                        consuming: false
                    })
                });
                const transportData = await transportResponse.json();
                
                producerTransport = device.createSendTransport({
                    id: transportData.id,
                    iceParameters: transportData.iceParameters,
                    iceCandidates: transportData.iceCandidates,
                    dtlsParameters: transportData.dtlsParameters
                });
                
                // Transport接続イベント
                producerTransport.on('connect', async ({ dtlsParameters }, callback, errback) => {
                    try {
                        await fetch(`${API_BASE}/transports/${producerTransport.id}/connect`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ dtlsParameters })
                        });
                        callback();
                    } catch (error) {
                        errback(error);
                    }
                });
                
                // Producer作成イベント
                producerTransport.on('produce', async ({ kind, rtpParameters }, callback, errback) => {
                    try {
                        const response = await fetch(`${API_BASE}/transports/${producerTransport.id}/producers`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ kind, rtpParameters })
                        });
                        const data = await response.json();
                        callback({ id: data.id });
                    } catch (error) {
                        errback(error);
                    }
                });
                
                // 映像トラック送信
                const videoTrack = localStream.getVideoTracks()[0];
                producer = await producerTransport.produce({
                    track: videoTrack,
                    encodings: [{ maxBitrate: 100000 }]
                });
                
                log(`映像送信開始: Producer ID ${producer.id}`);
                updateStatus('映像送信中', 'success');
                startSendingBtn.disabled = true;
                
            } catch (error) {
                log('映像送信に失敗: ' + error.message);
                updateStatus('送信エラー', 'error');
            }
        });
        
        // 映像受信開始
        startReceivingBtn.addEventListener('click', async () => {
            await checkExistingProducers();
        });
        
        // 既存プロデューサーをチェック
        async function checkExistingProducers() {
            try {
                const response = await fetch(`${API_BASE}/producers`);
                const data = await response.json();
                
                for (const producerInfo of data.producers) {
                    log(`プロデューサー発見: ${producerInfo.id} (${producerInfo.kind})`);
                    if (producerInfo.kind === 'video' && !consumers.has(producerInfo.id)) {
                        await consumeVideo(producerInfo.id);
                    }
                }
            } catch (error) {
                log('プロデューサー取得エラー: ' + error.message);
            }
        }
        
        // 映像受信
        async function consumeVideo(producerId) {
            try {
                // Consumer Transport作成
                if (!consumerTransport) {
                    const transportResponse = await fetch(`${API_BASE}/transports`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: 'consumer',
                            forceTcp: false,
                            producing: false,
                            consuming: true
                        })
                    });
                    const transportData = await transportResponse.json();
                    
                    consumerTransport = device.createRecvTransport({
                        id: transportData.id,
                        iceParameters: transportData.iceParameters,
                        iceCandidates: transportData.iceCandidates,
                        dtlsParameters: transportData.dtlsParameters
                    });
                    
                    // Transport接続イベント
                    consumerTransport.on('connect', async ({ dtlsParameters }, callback, errback) => {
                        try {
                            await fetch(`${API_BASE}/transports/${consumerTransport.id}/connect`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ dtlsParameters })
                            });
                            callback();
                        } catch (error) {
                            errback(error);
                        }
                    });
                }
                
                // Consumer作成
                const consumerResponse = await fetch(`${API_BASE}/transports/${consumerTransport.id}/consumers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        producerId: producerId,
                        rtpCapabilities: device.rtpCapabilities
                    })
                });
                const consumerData = await consumerResponse.json();
                
                const consumer = await consumerTransport.consume({
                    id: consumerData.id,
                    producerId: consumerData.producerId,
                    kind: consumerData.kind,
                    rtpParameters: consumerData.rtpParameters
                });
                
                // Consumer再開
                await fetch(`${API_BASE}/consumers/${consumer.id}/resume`, {
                    method: 'POST'
                });
                
                // リモート映像表示
                const stream = new MediaStream([consumer.track]);
                remoteVideo.srcObject = stream;
                
                consumers.set(producerId, consumer);
                log(`映像受信開始: Consumer ID ${consumer.id}`);
                updateStatus('映像受信中', 'success');
                
            } catch (error) {
                log('映像受信に失敗: ' + error.message);
                updateStatus('受信エラー', 'error');
            }
        }
        
        // 定期的にプロデューサーをチェック
        setInterval(() => {
            if (device && device.loaded) {
                checkExistingProducers();
            }
        }, 5000);
    </script>
</body>
</html>
